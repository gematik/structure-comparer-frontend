<div class="m-20" *ngIf="filtered">

    <h2>{{ filtered.name }}</h2>
    <div style="display: flex; justify-content: space-between;">
        <div style="flex: 1;">
            <ng-container *ngIf="filtered.sources.length > 1; else singleSource">
                <p>Source Profiles:</p>
                <ul>
                    <li *ngFor="let profile of filtered.sources">
                        <a [href]="profile.url" target="_blank">{{ profile.name }}</a>
                    </li>
                </ul>
            </ng-container>
            <ng-template #singleSource>
                <p>Source Profile:
                    <a [href]="filtered.sources[0].url" target="_blank">{{
                        filtered.sources[0].name }}</a>
                </p>
            </ng-template>

            <p>Target Profile:
                <a [href]="filtered.target.url" target="_blank">{{ filtered.target.name
                    }}</a>
            </p>
            <p>Version: {{ filtered.version }}, Status: {{ filtered.status }}</p>
            <p>Last updated on: {{ filtered.last_updated }}</p>
        </div>
        <div style="flex: 1; display: flex; justify-content: flex-end;">
            <div>
                <h3>Color Legend:</h3>
                <ul style="list-style: none; padding: 0;">
                    <li><span style="background-color: #DCF6E9;">&nbsp;&nbsp;&nbsp;&nbsp;</span> No action needed for
                        this mapping</li>
                    <li><span style="background-color: #FFEBE6;">&nbsp;&nbsp;&nbsp;&nbsp;</span> Information will be
                        removed or left empty in this mapping</li>
                    <li><span style="background-color: #FFFAE6;">&nbsp;&nbsp;&nbsp;&nbsp;</span> Special action required
                        for this mapping</li>
                    <li><span style="background-color: #ACF0F9;">&nbsp;&nbsp;&nbsp;&nbsp;</span> Caution reference!</li>
                </ul>
            </div>
        </div>
    </div>

    <div style="flex: 1; display: flex; justify-content: flex-end;">
        <mat-form-field fxFlex="40%">
            <input matInput type="text" (keyup)="handleTable($event).filter()" placeholder="Filter" />
        </mat-form-field>
    </div>
    <div style="max-height: 600px; overflow: auto;">
        <table id="resultsTable" class="display sticky-table" style="width: 100%" *ngIf="filtered?.fields?.length"
            matSort (matSortChange)="handleTable($event).sorter()">
            <thead>
                <tr>
                    <th class="default-th" mat-sort-header="name">Property</th>
                    <ng-container *ngFor="let profile of filtered.sources">
                        <th class="default-th" mat-sort-header="{{ profile.name }}">{{ profile.name }}</th>
                    </ng-container>
                    <th class="default-th" mat-sort-header="{{ filtered.target.name }}">
                        {{ filtered.target.name }}
                    </th>
                    <ng-container>
                        <th class="default-th" mat-sort-header="remark">Erläuterung</th>
                    </ng-container>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let field of filtered.fields; let i = index"
                    [ngClass]="getClassificationCssClass(field.action)">
                    <td class="default-td">
                        {{ field.name }}
                        <ng-container *ngIf="field.extension">
                            <br />({{ field.extension }})
                        </ng-container>
                    </td>
                    <ng-container *ngFor="let profile of filtered.sources.concat(filtered.target)">
                        <td class="default-td">
                            <ng-container *ngIf="isProfilePresent(field.profiles, profile.key)">X</ng-container>
                        </td>
                    </ng-container>
                    <td class="default-td" (mouseenter)="handleEdit(i).startHover()" (mouseleave)="handleEdit().stopHover()">
                        <span *ngIf="editingIndex !== i">{{ field.remark }}</span>
                        <button mat-button *ngIf="hoverIndex === i && editingIndex !== i" (click)="handleEdit(i).startEdit()" >
                            Ändern
                        </button>
                        <div *ngIf="editingIndex === i">
                            <div>Aktueller Stand: {{ field.remark }} {{ field.action }}</div>
                            <select [(ngModel)]="field.remark">
                                <option *ngFor="let classification of field.actions_allowed" [value]="classification">
                                    {{ getClassificationInstruction(classification) }}
                                </option>
                            </select>

                            <div *ngIf="field.remark === 'copy_from'">
                                <span>Wird aus&nbsp;</span>
                                <select [(ngModel)]="field.targetField">
                                    <option *ngFor="let availableField of availableFields" [value]="availableField.id">
                                        {{ availableField.name }}
                                    </option>
                                </select>
                                <span>&nbsp;übernommen</span>
                            </div>
                            <div *ngIf="field.remark === 'copy_to'">
                                <span>Wird in&nbsp;</span>
                                <select [(ngModel)]="field.targetField">
                                    <option *ngFor="let availableField of availableFields" [value]="availableField.id">
                                        {{ availableField.name }}
                                    </option>
                                </select>
                                <span>&nbsp;übernommen</span>
                            </div>
                            <div *ngIf="field.remark === 'fixed'">
                                <span>Wird fix auf&nbsp;</span>
                                <input type="text" [(ngModel)]="field.fixedValue" />
                                <span>&nbsp;gesetzt</span>
                            </div>
                            <button mat-button  (click)="confirmChanges(field)" class="mat-icon-button-sm confirm">
                                <i class="fas fa-check"></i>
                            </button>
                            <button mat-button class="mat-icon-button-sm cancel" (click)="handleEdit().cancelEdit()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>


    <mat-paginator (page)="handleTable($event).paginator()" [length]="totalLength" [pageSize]="pageSize"
        [showFirstLastButtons]="false" [pageSizeOptions]="pageSizeOptions" [pageIndex]="pageIndex"
        aria-label="Select page">
    </mat-paginator>
</div>